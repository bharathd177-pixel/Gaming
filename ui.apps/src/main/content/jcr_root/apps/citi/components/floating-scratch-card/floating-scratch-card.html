<!--/*-->
<!-- Floating Scratch Card Game Component -->
<!--/*-->

<!-- Include required clientlibs for Scratch Card component -->
<sly data-sly-use.clientlib="/libs/granite/sightly/templates/clientlib.html"
     data-sly-call="${clientlib.js @ categories='citi.base'}"/>

<!-- Add required CSS animations for scratch card game -->
<style>
         @keyframes confetti-fall {
         0% { 
             transform: translateY(-20px) rotate(0deg); 
             opacity: 1; 
         }
         100% { 
             transform: translateY(100vh) rotate(720deg); 
             opacity: 0; 
         }
     }
     
     @keyframes prize-reveal {
         0% { transform: scale(0) rotate(0deg); opacity: 0; }
         50% { transform: scale(1.2) rotate(5deg); opacity: 1; }
         100% { transform: scale(1) rotate(0deg); opacity: 1; }
     }
     
     @keyframes pulse {
         0%, 100% { transform: scale(1); }
         50% { transform: scale(1.05); }
     }
     
     @keyframes bounce {
         0%, 100% { transform: translateY(0); }
         50% { transform: translateY(-10px); }
     }
     
     @keyframes fadeIn {
         from { opacity: 0; transform: translateY(20px); }
         to { opacity: 1; transform: translateY(0); }
     }
     
     @keyframes scratch-hint {
         0%, 100% { opacity: 0.7; }
         50% { opacity: 1; }
     }
     
     .confetti-fall { animation: confetti-fall 3s linear infinite; }
     .prize-reveal { animation: prize-reveal 0.6s ease-out; }
     .pulse { animation: pulse 2s infinite; }
     .bounce { animation: bounce 1s infinite; }
     .fade-in { animation: fadeIn 0.5s ease-out; }
     .scratch-hint { animation: scratch-hint 2s infinite; }
</style>

<!-- Game trigger and modal system -->
<script>
// Wait for DOM to be ready
setTimeout(function() {
    if (typeof React !== 'undefined' && typeof ReactDOM !== 'undefined') {
        var useState = React.useState;
        var useEffect = React.useEffect;
        var useCallback = React.useCallback;
        var useRef = React.useRef;

        // Utility function for class names
        function cn() {
            var classes = [];
            for (var i = 0; i < arguments.length; i++) {
                var arg = arguments[i];
                if (!arg) continue;
                if (typeof arg === 'string') {
                    classes.push(arg);
                } else if (typeof arg === 'object') {
                    for (var key in arg) {
                        if (arg[key]) classes.push(key);
                    }
                }
            }
            return classes.join(' ');
        }

        // Enhanced Confetti Component
        var Confetti = function(props) {
            var isActive = props.isActive;
            
            useEffect(function() {
                if (!isActive) return;
                
                var confettiContainer = document.createElement('div');
                confettiContainer.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; overflow: hidden;';
                document.body.appendChild(confettiContainer);
                
                var colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff', '#ff9f43', '#00d2d3', '#5f27cd'];
                var shapes = ['circle', 'square', 'triangle'];
                
                for (var i = 0; i < 100; i++) {
                    var confetti = document.createElement('div');
                    var color = colors[Math.floor(Math.random() * colors.length)];
                    var shape = shapes[Math.floor(Math.random() * shapes.length)];
                    var size = Math.random() * 10 + 5;
                    var left = Math.random() * 100;
                    var animationDuration = Math.random() * 3 + 2;
                    var animationDelay = Math.random() * 2;
                    
                    confetti.style.cssText = 'position: absolute; left: ' + left + '%; top: -20px; width: ' + size + 'px; height: ' + size + 'px; background-color: ' + color + '; border-radius: ' + (shape === 'circle' ? '50%' : shape === 'triangle' ? '0' : '2px') + '; transform: ' + (shape === 'triangle' ? 'rotate(45deg)' : 'rotate(0deg)') + '; animation: confetti-fall ' + animationDuration + 's linear ' + animationDelay + 's infinite; z-index: ' + Math.floor(Math.random() * 10) + ';';
                    
                    confettiContainer.appendChild(confetti);
                }
                
                var cleanup = setTimeout(function() {
                    if (confettiContainer.parentNode) {
                        confettiContainer.parentNode.removeChild(confettiContainer);
                    }
                }, 6000);
                
                return function() {
                    clearTimeout(cleanup);
                    if (confettiContainer.parentNode) {
                        confettiContainer.parentNode.removeChild(confettiContainer);
                    }
                };
            }, [isActive]);
            
            return null;
        };

        // Button Component
        var Button = function(props) {
            var children = props.children;
            var onClick = props.onClick;
            var disabled = props.disabled;
            var style = props.style || {};
            
            var baseStyle = {
                display: 'inline-flex',
                alignItems: 'center',
                justifyContent: 'center',
                whiteSpace: 'nowrap',
                borderRadius: '8px',
                fontSize: '14px',
                fontWeight: '600',
                transition: 'all 0.2s',
                outline: 'none',
                border: 'none',
                cursor: 'pointer',
                padding: '12px 24px',
                opacity: disabled ? 0.5 : 1
            };
            
            return React.createElement('button', {
                style: Object.assign({}, baseStyle, style),
                onClick: onClick,
                disabled: disabled
            }, children);
        };

        // ScratchCardGame Component (without floating button)
        var ScratchCardGame = function(props) {
            // Get configuration from data attributes
            var configElement = document.querySelector('.sc-cmp-default');
            var config = {};

            if (configElement) {
                config.title = configElement.getAttribute('data-sc-title') || "Scratch & Win!";
                config.buttonText = configElement.getAttribute('data-sc-button-text') || "üé´ SCRATCH CARD";
                config.modalTitle = configElement.getAttribute('data-sc-modal-title') || "Scratch & Win!";
                config.modalSubtitle = configElement.getAttribute('data-sc-modal-subtitle') || "Enter your email and scratch the card to reveal your prize!";
                config.emailPlaceholder = configElement.getAttribute('data-sc-email-placeholder') || "Enter your email to play";
                config.playButtonText = configElement.getAttribute('data-sc-play-button-text') || "START SCRATCHING";
                config.scratchText = configElement.getAttribute('data-sc-scratch-text') || "Scratch here to reveal your prize!";
            }

            var prize = props.prize || {};
            
            // Dynamic prize selection logic
            var selectRandomPrize = function() {
                var availablePrizes = [];
                
                try {
                    // Handle different JSON structures
                    if (prize && Array.isArray(prize)) {
                        availablePrizes = prize;
                    } else if (prize && prize.prizes && Array.isArray(prize.prizes)) {
                        availablePrizes = prize.prizes;
                    } else if (prize && prize.prizes && typeof prize.prizes === 'string') {
                        try {
                            var parsedPrizes = JSON.parse(prize.prizes);
                            if (Array.isArray(parsedPrizes)) {
                                availablePrizes = parsedPrizes;
                            } else {
                                availablePrizes = [parsedPrizes];
                            }
                        } catch (parseError) {
                            console.error('Failed to parse prizes JSON string:', parseError);
                        }
                    } else if (prize && prize.text) {
                        availablePrizes = [prize];
                    } else if (typeof prize === 'string') {
                        var parsedPrize = JSON.parse(prize);
                        if (Array.isArray(parsedPrize)) {
                            availablePrizes = parsedPrize;
                        } else if (parsedPrize.prizes && Array.isArray(parsedPrize.prizes)) {
                            availablePrizes = parsedPrize.prizes;
                        } else if (parsedPrize.text) {
                            availablePrizes = [parsedPrize];
                        }
                    }
                    
                    // Special handling for the current data structure
                    if (prize && Array.isArray(prize) && prize.length > 0 && prize[0].prizes) {
                        try {
                            var parsedPrizes = JSON.parse(prize[0].prizes);
                            if (Array.isArray(parsedPrizes)) {
                                availablePrizes = parsedPrizes;
                            }
                        } catch (parseError) {
                            console.error('Failed to parse array[0].prizes:', parseError);
                        }
                    }
                } catch (e) {
                    console.error('Error parsing prizes:', e);
                }
                
                                 // Fallback to default prize if no prizes available
                 if (availablePrizes.length === 0) {
                     availablePrizes = [{
                         text: '10% OFF',
                         value: 'Save 10% on your next order',
                         icon: 'üéØ',
                         color: '#3b82f6',
                         probability: 100,
                         redeemCode: 'DEFAULT123'
                     }];
                 }
                 
                 console.log('üîç Available prizes before normalization:', availablePrizes);
                
                                 // Normalize prize properties to handle both formats
                 var normalizedPrizes = availablePrizes.map(function(p) {
                     return {
                         text: p.text || p.prizeText || '10% OFF',
                         value: p.value || p.prizeValue || 'Save 10% on your next order',
                         icon: p.icon || p.prizeIcon || 'üéØ',
                         color: p.color || p.prizeColor || '#3b82f6',
                         probability: p.probability || 25,
                         redeemCode: p.redeemCode || null
                     };
                 });
                 
                 // IMMEDIATE FIX: Generate redeem codes if null
                 normalizedPrizes.forEach(function(prize) {
                     if (!prize.redeemCode || prize.redeemCode.trim() === '') {
                         var baseCode = prize.text.replace(/[^A-Za-z0-9]/g, '').toUpperCase();
                         if (baseCode.length > 8) {
                             baseCode = baseCode.substring(0, 8);
                         }
                         prize.redeemCode = "SCRATCH" + baseCode + "123";
                         console.log('üîß Generated redeem code for:', prize.text, '->', prize.redeemCode);
                     }
                 });
                 
                 console.log('üîç Normalized prizes with redeem codes:', normalizedPrizes.map(function(p) { return { text: p.text, redeemCode: p.redeemCode }; }));
                
                // Select prize based on probability
                var totalProbability = normalizedPrizes.reduce(function(sum, p) {
                    return sum + (p.probability || 25);
                }, 0);
                
                var random = Math.random() * totalProbability;
                var currentSum = 0;
                
                for (var i = 0; i < normalizedPrizes.length; i++) {
                    currentSum += normalizedPrizes[i].probability || 25;
                    if (random <= currentSum) {
                        return normalizedPrizes[i];
                    }
                }
                
                return normalizedPrizes[0]; // Fallback
            };
            
            // Prize state to prevent blinking
            var _useState7 = useState(null);
            var selectedPrize = _useState7[0];
            var setSelectedPrize = _useState7[1];

            var canvasRef = useRef(null);

            var _useState = useState(false);
            var isModalOpen = _useState[0];
            var setIsModalOpen = _useState[1];

            var _useState2 = useState('');
            var email = _useState2[0];
            var setEmail = _useState2[1];

            var _useState3 = useState('initial');
            var gameState = _useState3[0];
            var setGameState = _useState3[1];

            var _useState4 = useState(false);
            var showConfetti = _useState4[0];
            var setShowConfetti = _useState4[1];

            var _useState5 = useState(false);
            var isScratching = _useState5[0];
            var setIsScratching = _useState5[1];

            var _useState6 = useState(0);
            var scratchPercentage = _useState6[0];
            var setScratchPercentage = _useState6[1];

            var _useState8 = useState(false);
            var isCanvasReady = _useState8[0];
            var setIsCanvasReady = _useState8[1];

            var openModal = function() {
                setIsModalOpen(true);
                setGameState('initial');
                setEmail('');
                setShowConfetti(false);
                setScratchPercentage(0);
                setSelectedPrize(null);
                setIsCanvasReady(false);
            };
            
            // Auto-open modal when component mounts (since it's triggered externally)
            useEffect(function() {
                openModal();
            }, []);
            
            // Initialize prize selection only when user starts scratching
            useEffect(function() {
                if (gameState === 'scratching' && !selectedPrize) {
                    var selectedPrizeData = selectRandomPrize();
                    console.log('üéØ Selected prize with redeem code:', selectedPrizeData);
                    setSelectedPrize(selectedPrizeData);
                }
            }, [gameState]);

            var closeModal = function() {
                setIsModalOpen(false);
                setGameState('initial');
                setEmail('');
                setShowConfetti(false);
                setScratchPercentage(0);
                setSelectedPrize(null);
                setIsCanvasReady(false);
                
                // Call the game trigger system to close the game
                if (window.scratchCardGameTrigger) {
                    window.scratchCardGameTrigger.closeGame();
                }
            };

                        var startGame = function() {
                if (!email.trim()) {
                    alert('Please enter your email address');
                    return;
                }
                
                setGameState('scratching');
            };

            var initializeCanvas = useCallback(function() {
                var canvas = canvasRef.current;
                if (!canvas) {
                    return;
                }

                try {
                    var ctx = canvas.getContext('2d');
                    if (!ctx) {
                        return;
                    }

                    var rect = canvas.getBoundingClientRect();
                    
                    var dpr = window.devicePixelRatio || 1;
                    canvas.width = rect.width * dpr;
                    canvas.height = rect.height * dpr;
                    ctx.scale(dpr, dpr);
                    
                    canvas.style.width = rect.width + 'px';
                    canvas.style.height = rect.height + 'px';

                    var gradient = ctx.createLinearGradient(0, 0, rect.width, rect.height);
                    gradient.addColorStop(0, '#f3f4f6');
                    gradient.addColorStop(0.3, '#e5e7eb');
                    gradient.addColorStop(0.7, '#d1d5db');
                    gradient.addColorStop(1, '#9ca3af');
                    
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, rect.width, rect.height);

                    var shineGradient = ctx.createLinearGradient(0, 0, 0, rect.height);
                    shineGradient.addColorStop(0, 'rgba(255, 255, 255, 0.4)');
                    shineGradient.addColorStop(0.5, 'rgba(255, 255, 255, 0.1)');
                    shineGradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
                    
                    ctx.fillStyle = shineGradient;
                    ctx.fillRect(0, 0, rect.width, rect.height);

                    ctx.fillStyle = '#374151';
                    ctx.font = 'bold 16px Arial, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.shadowColor = 'rgba(0, 0, 0, 0.2)';
                    ctx.shadowBlur = 1;
                    ctx.shadowOffsetX = 0;
                    ctx.shadowOffsetY = 1;
                    ctx.fillText(config.scratchText || 'Scratch here to reveal your prize!', rect.width / 2, rect.height / 2);
                    
                    ctx.font = '20px Arial';
                    ctx.fillText('üëÜ', rect.width / 2, rect.height / 2 + 25);
                    
                    setTimeout(function() {
                        setIsCanvasReady(true);
                    }, 200);
                } catch (error) {
                    setTimeout(function() {
                        setIsCanvasReady(true);
                    }, 500);
                }
            }, []);

            useEffect(function() {
                if (gameState === 'scratching' && selectedPrize && canvasRef.current) {
                    setTimeout(initializeCanvas, 100);
                }
            }, [gameState, selectedPrize, canvasRef.current]);

            var handleScratch = function(e) {
                var canvas = canvasRef.current;
                if (!canvas || gameState !== 'scratching') return;

                var ctx = canvas.getContext('2d');
                var rect = canvas.getBoundingClientRect();
                var x, y;

                if (e.type === 'mousemove' && e.buttons === 1) {
                    x = e.clientX - rect.left;
                    y = e.clientY - rect.top;
                } else if (e.type === 'touchmove') {
                    e.preventDefault();
                    var touch = e.touches[0];
                    x = touch.clientX - rect.left;
                    y = touch.clientY - rect.top;
                } else {
                    return;
                }

                ctx.globalCompositeOperation = 'destination-out';
                
                var dpr = window.devicePixelRatio || 1;
                var centerX = x * dpr;
                var centerY = y * dpr;
                var baseRadius = 20;
                
                ctx.beginPath();
                ctx.arc(centerX, centerY, baseRadius, 0, 2 * Math.PI);
                ctx.fill();
                
                for (var i = 0; i < 2; i++) {
                    var offsetX = (Math.random() - 0.5) * 8;
                    var offsetY = (Math.random() - 0.5) * 8;
                    var radius = baseRadius * 0.6 + Math.random() * 5;
                    
                    ctx.beginPath();
                    ctx.arc(centerX + offsetX, centerY + offsetY, radius, 0, 2 * Math.PI);
                    ctx.fill();
                }

                var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                var pixels = imageData.data;
                var transparent = 0;
                
                for (var i = 3; i < pixels.length; i += 4) {
                    if (pixels[i] === 0) transparent++;
                }
                
                var percentage = (transparent / (pixels.length / 4)) * 100;
                setScratchPercentage(percentage);
                
                if (percentage > 30 && gameState === 'scratching') {
                    setGameState('won');
                    setShowConfetti(true);
                    
                    setTimeout(function() {
                        setShowConfetti(false);
                    }, 3000);
                }
            };

            return React.createElement(React.Fragment, {}, [
                React.createElement(Confetti, { key: 'confetti', isActive: showConfetti }),
                
                // Modal
                isModalOpen && React.createElement('div', {
                    key: 'modal',
                    style: {
                        position: 'fixed',
                        inset: '0',
                        zIndex: 50,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        padding: '16px',
                        backgroundColor: 'rgba(0,0,0,0.5)'
                    },
                    onClick: function(e) {
                        if (e.target === e.currentTarget) closeModal();
                    }
                }, [
                    React.createElement('div', {
                        key: 'modal-content',
                        style: {
                            position: 'relative',
                            width: '100%',
                            maxWidth: '32rem',
                            maxHeight: '90vh',
                            overflow: 'hidden',
                            backgroundColor: 'white',
                            borderRadius: '16px',
                            boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)'
                        }
                    }, [
                        // Header
                        React.createElement('div', {
                            key: 'header',
                            className: 'p-6 border-b border-gray-200'
                        }, [
                            React.createElement('div', {
                                key: 'header-content',
                                className: 'flex items-center justify-between'
                            }, [
                                React.createElement('div', { key: 'title-section' }, [
                                    React.createElement('h2', {
                                        key: 'title',
                                        className: 'text-2xl font-bold text-gray-900'
                                    }, config.modalTitle),
                                    React.createElement('p', {
                                        key: 'subtitle',
                                        className: 'text-gray-600 mt-1'
                                    }, config.modalSubtitle)
                                ]),
                                React.createElement('button', {
                                    key: 'close-button',
                                    onClick: closeModal,
                                    style: {
                                        position: 'absolute',
                                        top: '16px',
                                        right: '16px',
                                        zIndex: 10,
                                        background: 'none',
                                        border: 'none',
                                        fontSize: '24px',
                                        color: '#9ca3af',
                                        cursor: 'pointer',
                                        padding: '8px',
                                        borderRadius: '4px',
                                        transition: 'color 0.2s'
                                    },
                                    onMouseEnter: function(e) {
                                        e.target.style.color = '#6b7280';
                                    },
                                    onMouseLeave: function(e) {
                                        e.target.style.color = '#9ca3af';
                                    }
                                }, '‚úï')
                            ])
                        ]),
                        
                        // Content
                        React.createElement('div', {
                            key: 'content',
                            className: 'p-6'
                        }, [
                            // Email Input (initial state)
                            gameState === 'initial' && React.createElement('div', {
                                key: 'email-section',
                                className: 'space-y-4'
                            }, [
                                React.createElement('input', {
                                    key: 'email-input',
                                    type: 'email',
                                    placeholder: config.emailPlaceholder,
                                    value: email,
                                    onChange: function(e) { setEmail(e.target.value); },
                                    style: {
                                        width: '100%',
                                        padding: '12px 16px',
                                        border: '1px solid #d1d5db',
                                        borderRadius: '8px',
                                        marginBottom: '16px',
                                        fontSize: '16px',
                                        outline: 'none',
                                        boxSizing: 'border-box'
                                    }
                                }),
                                React.createElement(Button, {
                                    key: 'play-button',
                                    onClick: startGame,
                                    style: {
                                        width: '100%',
                                        background: 'linear-gradient(135deg, #f97316, #dc2626)',
                                        color: 'white',
                                        fontWeight: '600',
                                        padding: '16px 24px',
                                        borderRadius: '8px',
                                        border: 'none',
                                        cursor: 'pointer',
                                        fontSize: '16px',
                                        boxShadow: '0 4px 14px 0 rgba(249, 115, 22, 0.39)'
                                    }
                                }, config.playButtonText)
                            ]),
                            
                                                         // Scratch Card (scratching state)
                             gameState === 'scratching' && selectedPrize && React.createElement('div', {
                                 key: 'scratch-card',
                                 className: 'relative'
                             }, [
                                 // Prize underneath - HIDDEN until scratched
                                 React.createElement('div', {
                                     key: 'prize-underneath',
                                     className: 'absolute inset-0 rounded-lg flex flex-col items-center justify-center text-white font-bold text-center p-4',
                                     style: { 
                                         backgroundColor: selectedPrize.color || '#3b82f6',
                                         opacity: scratchPercentage > 10 ? 1 : 0,
                                         transition: 'opacity 0.3s ease'
                                     }
                                 }, [
                                    React.createElement('div', {
                                        key: 'prize-icon',
                                        className: 'text-4xl mb-2'
                                    }, selectedPrize.icon || 'üéØ'),
                                    React.createElement('div', {
                                        key: 'prize-text',
                                        className: 'text-xl font-bold'
                                    }, selectedPrize.text || '10% OFF'),
                                    React.createElement('div', {
                                        key: 'prize-value',
                                        className: 'text-sm mt-1 opacity-90'
                                    }, selectedPrize.value || 'Save 10% on your next order')
                                ]),
                                
                                // Scratch canvas
                                React.createElement('canvas', {
                                    key: 'scratch-canvas',
                                    ref: canvasRef,
                                    onMouseMove: handleScratch,
                                    onTouchMove: handleScratch,
                                    className: 'w-full h-48 rounded-lg cursor-pointer touch-none scratch-hint',
                                    style: { 
                                        touchAction: 'none',
                                        opacity: isCanvasReady ? 1 : 0.5
                                    }
                                }),
                                
                                // Loading overlay while canvas initializes
                                !isCanvasReady && React.createElement('div', {
                                    key: 'canvas-loading-overlay',
                                    className: 'absolute inset-0 flex items-center justify-center bg-gray-100 bg-opacity-75 rounded-lg',
                                    style: { zIndex: 10 }
                                }, [
                                    React.createElement('div', {
                                        key: 'canvas-loading-spinner',
                                        className: 'text-2xl'
                                    }, '‚è≥'),
                                    React.createElement('div', {
                                        key: 'canvas-loading-text',
                                        style: {
                                            color: '#6b7280',
                                            fontSize: '14px',
                                            marginLeft: '8px'
                                        }
                                    }, 'Initializing...')
                                ])
                            ]),
                            
                            // Loading state while initializing
                            gameState === 'scratching' && !selectedPrize && React.createElement('div', {
                                key: 'loading',
                                className: 'text-center p-8'
                            }, [
                                React.createElement('div', {
                                    key: 'loading-spinner',
                                    className: 'text-4xl mb-4'
                                }, '‚è≥'),
                                React.createElement('div', {
                                    key: 'loading-text',
                                    style: {
                                        color: '#6b7280',
                                        fontSize: '16px'
                                    }
                                }, 'Preparing your scratch card...')
                            ]),
                            
                            // Result (won state)
                            gameState === 'won' && selectedPrize && React.createElement('div', {
                                key: 'result',
                                className: 'text-center space-y-4 fade-in'
                            }, [
                                
                                React.createElement('div', {
                                    key: 'result-icon',
                                    className: 'text-6xl'
                                }, 'üéâ'),
                                
                                React.createElement('h3', {
                                    key: 'result-title',
                                    className: 'text-2xl font-bold text-green-600'
                                }, 'Congratulations!'),
                                
                                React.createElement('p', {
                                    key: 'prize-message',
                                    className: 'text-lg text-gray-700'
                                }, 'You won a ' + (selectedPrize.text || '10% OFF') + '!'),
                                
                                React.createElement('div', {
                                    key: 'prize-details',
                                    className: 'bg-gradient-to-r from-orange-50 to-red-50 rounded-lg p-4 prize-reveal'
                                }, [
                                    React.createElement('div', {
                                        key: 'prize-icon-large',
                                        className: 'text-4xl mb-2'
                                    }, selectedPrize.icon || 'üéØ'),
                                    React.createElement('div', {
                                        key: 'prize-name',
                                        style: {
                                            fontWeight: '600',
                                            fontSize: '18px',
                                            color: '#111827'
                                        }
                                    }, selectedPrize.text || '10% OFF'),
                                    React.createElement('div', {
                                        key: 'prize-description',
                                        style: {
                                            color: '#6b7280',
                                            fontSize: '14px',
                                            marginTop: '4px'
                                        }
                                    }, selectedPrize.value || 'Save 10% on your next order'),
                                    selectedPrize.redeemCode && React.createElement('div', {
                                        key: 'redeem-code',
                                        className: 'mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg'
                                    }, [
                                        React.createElement('p', {
                                            key: 'redeem-label',
                                            className: 'text-sm font-medium text-yellow-800 mb-1'
                                        }, 'Your Redeem Code:'),
                                        React.createElement('p', {
                                            key: 'redeem-value',
                                            className: 'text-lg font-bold text-yellow-900 font-mono'
                                        }, selectedPrize.redeemCode)
                                    ])
                                ]),
                                
                                React.createElement(Button, {
                                    key: 'play-again-button',
                                    onClick: function() {
                                        setGameState('initial');
                                        setEmail('');
                                        setScratchPercentage(0);
                                    },
                                    style: {
                                        background: 'linear-gradient(135deg, #f97316, #dc2626)',
                                        color: 'white',
                                        fontWeight: '600',
                                        padding: '16px 32px',
                                        borderRadius: '12px',
                                        border: 'none',
                                        cursor: 'pointer',
                                        fontSize: '16px',
                                        boxShadow: '0 4px 14px 0 rgba(249, 115, 22, 0.39)',
                                        transition: 'all 0.3s ease'
                                    },
                                    onMouseEnter: function(e) {
                                        e.target.style.transform = 'translateY(-2px)';
                                        e.target.style.boxShadow = '0 6px 20px 0 rgba(249, 115, 22, 0.5)';
                                    },
                                    onMouseLeave: function(e) {
                                        e.target.style.transform = 'translateY(0)';
                                        e.target.style.boxShadow = '0 4px 14px 0 rgba(249, 115, 22, 0.39)';
                                    }
                                }, 'Play Again')
                            ])
                        ])
                    ])
                ])
            ]);
        };

        // Game trigger system
        var gameTriggerSystem = {
            isGameOpen: false,
            gameContainer: null,
            gameRoot: null,
            
            init: function() {
                this.setupTriggerListeners();
                
                // Also listen for dynamically added elements
                this.observeDOMChanges();
            },
            
            setupTriggerListeners: function() {
                // Find all anchor tags with href="#game-initiate"
                var triggerElements = document.querySelectorAll('a[href="#game-initiate"]');
                
                triggerElements.forEach(function(element) {
                    // Remove existing listeners by cloning
                    var newElement = element.cloneNode(true);
                    element.parentNode.replaceChild(newElement, element);
                    
                    // Add new listener
                    newElement.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // Only open if game is not already open
                        if (!gameTriggerSystem.isGameOpen) {
                            gameTriggerSystem.openGame();
                        }
                    });
                });
            },
            
            observeDOMChanges: function() {
                // Use MutationObserver to watch for dynamically added elements
                if (typeof MutationObserver !== 'undefined') {
                    var observer = new MutationObserver(function(mutations) {
                        var shouldSetup = false;
                        mutations.forEach(function(mutation) {
                            if (mutation.type === 'childList') {
                                mutation.addedNodes.forEach(function(node) {
                                    if (node.nodeType === 1) { // Element node
                                        if (node.matches && node.matches('a[href="#game-initiate"]')) {
                                            shouldSetup = true;
                                        }
                                        if (node.querySelectorAll) {
                                            var links = node.querySelectorAll('a[href="#game-initiate"]');
                                            if (links.length > 0) {
                                                shouldSetup = true;
                                            }
                                        }
                                    }
                                });
                            }
                        });
                        
                        if (shouldSetup) {
                            gameTriggerSystem.setupTriggerListeners();
                        }
                    });
                    
                    observer.observe(document.body, {
                        childList: true,
                        subtree: true
                    });
                }
            },
            
            openGame: function() {
                if (this.isGameOpen) return;
                
                this.isGameOpen = true;
                
                // Create game container if it doesn't exist
                if (!this.gameContainer) {
                    this.gameContainer = document.createElement('div');
                    this.gameContainer.id = 'scratch-card-game-container';
                    this.gameContainer.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; pointer-events: auto;';
                    document.body.appendChild(this.gameContainer);
                }
                
                                 // Get prize data
                 var prizeScript = document.getElementById('floating-scratch-card-prize');
                 var prize = {};
                 
                 console.log('üîç Raw prize script content:', prizeScript ? prizeScript.textContent : 'No script found');
                
                if (prizeScript) {
                    try {
                        var parsedPrize = JSON.parse(prizeScript.textContent);
                        
                        if (Array.isArray(parsedPrize)) {
                            prize = parsedPrize;
                        } else if (parsedPrize && parsedPrize.prizes && Array.isArray(parsedPrize.prizes)) {
                            prize = parsedPrize.prizes;
                        } else if (parsedPrize && parsedPrize.text) {
                            prize = [parsedPrize];
                        } else if (parsedPrize && typeof parsedPrize === 'object') {
                            for (var key in parsedPrize) {
                                if (Array.isArray(parsedPrize[key])) {
                                    prize = parsedPrize[key];
                                    break;
                                }
                            }
                            if (!Array.isArray(prize)) {
                                prize = [parsedPrize];
                            }
                        } else {
                            prize = [];
                        }
                    } catch (e) {
                        console.error('Failed to parse prize JSON:', e);
                        prize = [];
                    }
                }
                
                // Render the game
                try {
                    this.gameRoot = ReactDOM.createRoot(this.gameContainer);
                    this.gameRoot.render(React.createElement(ScratchCardGame, {
                        prize: prize,
                        onClose: function() {
                            gameTriggerSystem.closeGame();
                        }
                    }));
                } catch (error) {
                    console.error('React rendering failed:', error);
                    this.isGameOpen = false;
                }
            },
            
            closeGame: function() {
                if (!this.isGameOpen) return;
                
                this.isGameOpen = false;
                
                // Clean up React root
                if (this.gameRoot) {
                    try {
                        this.gameRoot.unmount();
                    } catch (e) {
                        // Ignore unmount errors
                    }
                    this.gameRoot = null;
                }
                
                // Remove container
                if (this.gameContainer && this.gameContainer.parentNode) {
                    this.gameContainer.parentNode.removeChild(this.gameContainer);
                    this.gameContainer = null;
                }
            }
        };
        
        // Initialize the game trigger system
        gameTriggerSystem.init();
        
        // Also set up a global click handler as backup
        document.addEventListener('click', function(e) {
            if (e.target.tagName === 'A' && e.target.getAttribute('href') === '#game-initiate') {
                e.preventDefault();
                e.stopPropagation();
                
                if (!gameTriggerSystem.isGameOpen) {
                    gameTriggerSystem.openGame();
                }
            }
        });
        
        // Expose the game trigger system globally for manual control
        window.scratchCardGameTrigger = gameTriggerSystem;
        
    } else {
        console.error('React dependencies not found');
    }
}, 1000);
</script>

<!-- Scratch Card Game Component -->
<div data-sly-use.model="com.citi.hub.core.models.ScratchCardModel">
    <!-- Author mode edit placeholder -->
    <div data-sly-test="${wcmmode.edit}" class="cq-placeholder" data-emptytext="Scratch Card Game - Configure prize and settings"></div>

    <!-- Configuration data -->
    <div class="sc-cmp-default"
         data-sc-title="${model.title}"
         data-sc-button-text="${model.buttonText}"
         data-sc-modal-title="${model.modalTitle}"
         data-sc-modal-subtitle="${model.modalSubtitle}"
         data-sc-email-placeholder="${model.emailPlaceholder}"
         data-sc-play-button-text="${model.playButtonText}"
         data-sc-scratch-text="${model.scratchText}">
    </div>

    <!-- Prize data in script tag -->
    <script type="application/json" id="floating-scratch-card-prize">
        ${model.prizeJson || '{}' @ context='unsafe'}
    </script>
</div>
